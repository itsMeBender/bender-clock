<link rel="import" href="../polymer/polymer.html">

<!--
`bender-clock`
Display an analog clock.

<bender-clock hhmm="21:45"></bender-clock>

@demo demo/index.html 
-->

<dom-module id="bender-clock">
  <template>
    <style>
      :host {
        display: block;
      }
      .clock {
        width: 10em;
        height: 10em;
      }
      .clock--frame {
        border: solid 4px #FFFFFF;
        border-radius: 5em;   /* Half of the parent size */
        width: inherit;
        height: inherit;
        box-sizing: border-box;
        background-color: #000000;
        position: relative;        
      }
      .hour--frame,
      .minute--frame,
      .second--frame {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .hour--frame {
        animation: rotate 43200s infinite linear;
      }
      .minute--frame {
        animation: rotate 3600s infinite linear;
      }
      .second--frame {
        animation: rotate 60s infinite  steps(60);
      }

      .hour {
        position: absolute;
        background-color: #EEEEEE;
        width: 0.4em;
        height: 2.8em;
        transform-origin: 50% 50%;
        bottom: 4.3em;
        right: 4.51em;
      }
      .minute {
        position: absolute;
        background-color: #EEEEEE;
        width: 0.2em;
        height: 4.4em;
        transform-origin: 50% 50%;
        bottom: 4.1em;
        right: 4.62em;
      }
      .second {
        position: absolute;
        background-color: #EEEEEE;
        width: 0.1em;
        height: 5.4em;
        transform-origin: 50% 50%;
        bottom: 3.5em;
        right: 4.65em;
      }
      @keyframes rotate {
        100% {
          transform: rotateZ(360deg);
        }
      }
    </style>
    <div class="clock">
      <div class="clock--frame">
        <div class="hour--frame">
          <div class="hour"></div>
        </div>
        <div class="minute--frame">
          <div class="minute"></div>
        </div>
        <div class="second--frame">
          <div class="second"></div>
        </div>
        <div class="digits">
        </div>
      </div>
    </div>
  </template>

  <script>
    Polymer({

      changeDimensions: function (dimension) {
        console.log("TODO: dimension", dimension);
      },

      // Change time with format HH, HH:MM, HH:MM:SS
      changeTime: function (time) {
        var clock = new Date();
        var hours;
        var minutes;
        var seconds;
        var that = this;
        var timeParts;

        if (time) {

          // Validate input
          if (typeof time === 'string') {

            // Defaults
            hours = 0;
            minutes = 0;
            seconds = 0;                  

            timeParts = time.split(':');
            switch (timeParts.length) {
              case 3:
                seconds = validSeconds(timeParts[2]);
              case 2:
                minutes = validMinutes(timeParts[1]) * 60;    // In seconds
              case 1:
                hours   = validHours(timeParts[0]) * 3600;    // In seconds
                break;
              default:
                throw "Attribute `time` unexpected format";
            }
          } else {
            throw "Attribute `time` unexpected format";
          }

        } else {
          // Use current local time
          hours = validHours(clock.getHours()) * 3600;    // In seconds
          minutes = clock.getMinutes() * 60;  // In seconds
          seconds = clock.getSeconds();

        }

        // Degrees as time / scale ratio to 360 circle
        setRotationForElement (Math.round((hours + minutes + seconds) / 43200 * 360), '.hour--frame');
        setRotationForElement (Math.round((minutes + seconds) / 3600 * 360), '.minute--frame');
        setRotationForElement (Math.round(seconds / 60 * 360), '.second--frame');

        /**
         * Set the rotation ANGLE of the container frame, identied by a unique CLASSNAME
         * @param {number} angle The calculated ANGLE of the ELEMENT 0..360
         * @param {string} className The unique identifier of the ELEMENT to be rotated
         */
        function setRotationForElement (angle, className) {
          var element = that.querySelector(className);
          element.style.webkitTransform = 'rotateZ('+ angle +'deg)';
          element.style.transform = 'rotateZ('+ angle +'deg)';
        }

        /**
         * Validate if value is an accaptable hour range 0..23
         * @param {string} hours The time in HOURS, 0..23
         * @return {number} Of hours 0..12, 12-hour analog clock
         */
        function validHours (hours) {
          if (isNaN(hours)) {
            throw "Attribute `time` unexpected format";                
          } else {
            hours = parseInt(hours, 10);
            if (hours < 0 || hours > 23) {
              throw "Attribute `time` unexpected format";                                
            }
          }
          // Convert to 12 hour clock.
          return hours > 12 ? hours - 12 : hours;
        }

        /**
         * Validate if value is an accaptable minute range 0..59
         * @param {string} minutes The time MINUTES, 0..59
         * @return {number} minutes
         */
        function validMinutes (minutes) {
          if (isNaN(minutes)) {
            throw "Attribute `time` unexpected format";                
          } else {
            minutes = parseInt(minutes, 10);
            if (minutes < 0 || minutes > 59) {
              throw "Attribute `time` unexpected format";                                
            }
          }
          return minutes;
        }

        /**
         * Validate if value is an accaptable minute range 0..59
         * @param {string} seconds The time SECONDS, 0..59
         * @return {number} seconds
         */
        function validSeconds (seconds) {
          if (isNaN(seconds)) {
            throw "Attribute `time` unexpected format";                
          } else {
            seconds = parseInt(seconds, 10);
            if (seconds < 0 || seconds > 59) {
              throw "Attribute `time` unexpected format";                                
            }
          }
          return seconds;
        }
      },

      is: 'bender-clock',

      properties: {
        time: {
          type: String,
          value: '',
          observer: "changeTime"
        },
      },

    });
  </script>
</dom-module>
