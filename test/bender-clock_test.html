<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>bender-clock test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../bender-clock.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <bender-clock></bender-clock>
      </template>
    </test-fixture>

    <script>
      suite('bender-clock', function() {
        /* global
          setup, expect, sinon
        */
        var clock;
        var element;
        var hour;
        var hourRotation;
        var minute;
        var minuteRotation;
        var second;
        var secondRotation;

        setup(function() {
          element = fixture('basic');

          // Frame rotation is the starting rotation of given time.
          // These elements are under control of the JavaScript to handle the initial start time rotation.
          hour = element.$$('.hour--frame');
          minute = element.$$('.minute--frame');
          second = element.$$('.second--frame');

          // This is the full 360deg, hour, minute and second (hand) rotation.
          // Animated by CSS 'animation: rotate 43200s infinite linear'.
          hourRotation = element.$$('.hour--full-rotation');
          minuteRotation = element.$$('.minute--full-rotation');
          secondRotation = element.$$('.second--full-rotation');
        });

        // Element
        test('A01 - Instantiating the element works', function() {
          // Chai assertions 'expect'
          // expect(request.response).to.be.ok;
          expect(element.is).to.be.equal('bender-clock');

          // Rotation container frames
          expect(hour.nodeName).to.be.equal('DIV');
          expect(minute.nodeName).to.be.equal('DIV');
          expect(second.nodeName).to.be.equal('DIV');

          // Hour, minute and second clock pointer, identified by className
          expect(hourRotation.firstElementChild.classList[0]).to.be.equal('hour');
          expect(minuteRotation.firstElementChild.classList[0]).to.be.equal('minute');
          expect(secondRotation.firstElementChild.classList[0]).to.be.equal('second');
        });


        // Function changeTime()
        test('B01 - Function changeTime() default to local time', function(done) {
          // Give sinon.useFakeTimers() some time to respond
          setTimeout(function() {
            // No parameter given, set to local time 09:15:30 - March 30, 2017, using fake time
            element.changeTime();

            expect(hour.style.transform).to.be.equal('rotateZ(278deg)');
            expect(minute.style.transform).to.be.equal('rotateZ(93deg)');
            expect(second.style.transform).to.be.equal('rotateZ(180deg)');

            clock.restore();
            done();
          }, 10);

          // Current time 09:15:30 - March 30, 2017
          // using simple numbers, to calculate rotation 0, 90, 180, 240, 360 in degrees
          clock = sinon.useFakeTimers(new Date(2017, 2, 30, 9, 15, 30).getTime());
        });

        // ///////////////////////////////////////////////////////////////////////
        // Functions
        // ///////////////////////////////////////////////////////////////////////

        // Expected input HH:MM:SS as in 23:59:59
        test('B02 - Function changeTime(time:String), time parameter', function() {
          element.changeTime('3:45'); // Set TIME to 10 hours and 45 minutes
          expect(hour.style.transform).to.be.equal('rotateZ(113deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(270deg)');
          expect(second.style.transform).to.be.equal('rotateZ(0deg)');

          element.changeTime('22:30'); // Set TIME to 22 hours and 30 minutes
          expect(hour.style.transform).to.be.equal('rotateZ(315deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(180deg)');
          expect(second.style.transform).to.be.equal('rotateZ(0deg)');

          element.changeTime('0:30:30'); // Set TIME to 0 hours, 30 minutes and 30 seconds
          expect(hour.style.transform).to.be.equal('rotateZ(15deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(183deg)');
          expect(second.style.transform).to.be.equal('rotateZ(180deg)');

          element.changeTime('15'); // Set TIME to 15hours
          expect(hour.style.transform).to.be.equal('rotateZ(90deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(0deg)');
          expect(second.style.transform).to.be.equal('rotateZ(0deg)');
        });

        test('B03 - Changing time attribute', function() {
          element.setAttribute('time', '3:45'); // Set TIME to 10 hours and 45 minutes
          expect(hour.style.transform).to.be.equal('rotateZ(113deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(270deg)');
          expect(second.style.transform).to.be.equal('rotateZ(0deg)');

          element.setAttribute('time', '22:30'); // Set TIME to 10 hours and 45 minutes
          expect(hour.style.transform).to.be.equal('rotateZ(315deg)');
          expect(minute.style.transform).to.be.equal('rotateZ(180deg)');
          expect(second.style.transform).to.be.equal('rotateZ(0deg)');
        });

        test('B04 - Parameter validation changeTime()', function() {
          assert.throws(function() {
            element.changeTime('00:00:60');
          }, 'Attribute `time` unexpected format seconds.', 'Error thrown on `00:60`');
          assert.throws(function() {
            element.changeTime('00:00:G0');
          }, 'Attribute `time` unexpected format seconds.', 'Error thrown on `00:G0`'); // 'G' in time

          assert.throws(function() {
            element.changeTime('00:60:00');
          }, 'Attribute `time` unexpected format minutes.', 'Error thrown on `00:60`');
          assert.throws(function() {
            element.changeTime('00:G0:00');
          }, 'Attribute `time` unexpected format minutes.', 'Error thrown on `00:G0`'); // 'G' in time

          assert.throws(function() {
            element.changeTime('24:00:00');
          }, 'Attribute `time` unexpected format hours.', 'Error thrown on `24:00`'); // 23:59:59 to 00:00:00
          assert.throws(function() {
            element.changeTime('2A:00:00');
          }, 'Attribute `time` unexpected format hours.', 'Error thrown on `2A:00`'); // 'A' in time

          assert.throws(function() {
            element.changeTime('12345678');
          }, 'Attribute `time` unexpected format', 'Error thrown on `12345678`');
          assert.throws(function() {
            element.changeTime('HH:MM');
          }, 'Attribute `time` unexpected format', 'Error thrown on `HH:MM`');
        });

        test('B05 - Function changeTime(time:String), check on event fired', function() {
          sinon.spy(element, 'fire');
          element.changeTime('1:23');
          expect(element.fire).to.have.been.calledWith('bender-clock-time-changed', {'timeset': '1:23'});
        });
      });
    </script>
  </body>
</html>
